<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="Admin Panel - Wait List Management" />
    <meta name="author" content="Daniel Wait" />
    <title>Admin Panel - Wait List Management</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/logo.png" />
    <!-- Custom Google font-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@100;200;300;400;500;600;700;800;900&amp;display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />
    <!-- Core theme CSS (includes Bootstrap) -->
    <link href="css/styles.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="css/myStyles.css" />
    <script src="js/nav-component.js"></script>
    <style>
      /* Dark mode variables for admin panel */
      :root {
        --admin-bg: #ffffff;
        --admin-panel-bg: #ffffff;
        --admin-text: #333333;
        --admin-border: #e0e0e0;
        --admin-shadow: rgba(0, 0, 0, 0.1);
        --table-bg: #ffffff;
        --table-hover: #f8f9fa;
        --input-bg: #ffffff;
        --loading-bg: rgba(255, 255, 255, 0.95);
        --modal-bg: #ffffff;
        --spinner-border: #f3f3f3;
        --tab-bg: #ffffff;
        --tab-border: #dee2e6;
        --empty-state-bg: #f8f9fa;
      }
      
      @media (prefers-color-scheme: dark) {
        :root {
          --admin-bg: #121212;
          --admin-panel-bg: #1e1e1e;
          --admin-text: #ffffff;
          --admin-border: #333333;
          --admin-shadow: rgba(255, 255, 255, 0.1);
          --table-bg: #1e1e1e;
          --table-hover: #2a2a2a;
          --input-bg: #2a2a2a;
          --loading-bg: rgba(18, 18, 18, 0.95);
          --modal-bg: #1e1e1e;
          --spinner-border: #333333;
          --tab-bg: #1e1e1e;
          --tab-border: #333333;
          --empty-state-bg: #2a2a2a;
        }
      }
      
      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      
      .admin-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 3px solid #dc3545;
        padding-bottom: 20px;
      }
      
      .admin-title {
        font-size: 2.5rem;
        font-weight: bold;
        color: #dc3545;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      
      .admin-subtitle {
        font-size: 1.1rem;
        color: #666;
        margin-top: 10px;
      }
      
      .admin-panel {
        background: var(--admin-panel-bg);
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px var(--admin-shadow);
        color: var(--admin-text);
      }
      
      .admin-panel h3 {
        color: #007bff;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .form-group {
        margin-bottom: 15px;
      }
      
      .form-group label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }
      
      .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--admin-border);
        border-radius: 4px;
        font-size: 14px;
        background: var(--input-bg);
        color: var(--admin-text);
      }
      
      .btn-admin {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      
      .btn-admin:hover {
        background: #0056b3;
        transform: translateY(-1px);
      }
      
      .btn-danger {
        background: #dc3545;
      }
      
      .btn-danger:hover {
        background: #c82333;
      }
      
      .btn-success {
        background: #28a745;
      }
      
      .btn-success:hover {
        background: #218838;
      }
      
      .links-table {
        background: var(--table-bg);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px var(--admin-shadow);
        color: var(--admin-text);
      }
      
      .table {
        margin: 0;
      }
      
      .table th {
        background: var(--empty-state-bg);
        border-bottom: 2px solid var(--admin-border);
        font-weight: bold;
        color: var(--admin-text);
      }
      
      .table td {
        vertical-align: middle;
        border-bottom: 1px solid var(--admin-border);
      }
      
      .table tbody tr:hover {
        background-color: var(--table-hover);
      }
      
      .link-title {
        color: #007bff;
        text-decoration: underline;
        font-weight: bold;
      }
      
      .link-title:hover {
        color: #0056b3;
        text-decoration: none;
      }
      
      .action-buttons {
        display: flex;
        gap: 8px;
      }
      
      .btn-sm {
        padding: 6px 12px;
        font-size: 0.875rem;
      }
      
      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
      }
      
      .status-active {
        background: #d4edda;
        color: #155724;
      }
      
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--admin-text);
        background: var(--empty-state-bg);
        border-radius: 8px;
      }
      
      .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #ddd;
      }
      
      .empty-state h4 {
        margin-bottom: 10px;
        color: #333;
      }
      
      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .stat-card {
        background: var(--admin-panel-bg);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 10px var(--admin-shadow);
        color: var(--admin-text);
      }
      
      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
      }
      
             .stat-label {
         color: #666;
         font-size: 0.9rem;
       }
       
       .loading-screen {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: var(--loading-bg);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 9999;
       }
       
       .loading-content {
         text-align: center;
         padding: 40px;
       }
       
       .loading-content h3 {
         color: #dc3545;
         margin: 20px 0 10px 0;
         font-weight: bold;
       }
       
       .loading-content p {
         color: #666;
         margin: 0;
       }
       
       .spinner {
         border: 4px solid #f3f3f3;
         border-top: 4px solid #dc3545;
         border-radius: 50%;
         width: 50px;
         height: 50px;
         animation: spin 1s linear infinite;
         margin: 0 auto;
       }
       
       @keyframes spin {
         0% { transform: rotate(0deg); }
         100% { transform: rotate(360deg); }
       }
       
       .edit-modal {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0, 0, 0, 0.5);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 10000;
       }
       
       .edit-modal-content {
         background: var(--modal-bg);
         border-radius: 8px;
         padding: 0;
         max-width: 500px;
         width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         box-shadow: 0 4px 20px rgba(0,0,0,0.3);
         color: var(--admin-text);
       }
       
       .edit-modal-header {
         background: var(--empty-state-bg);
         padding: 20px;
         border-bottom: 1px solid var(--admin-border);
         display: flex;
         justify-content: space-between;
         align-items: center;
         border-radius: 8px 8px 0 0;
       }
       
       .edit-modal-header h3 {
         margin: 0;
         color: #007bff;
         display: flex;
         align-items: center;
         gap: 10px;
       }
       
       .close-btn {
         background: none;
         border: none;
         font-size: 1.5rem;
         cursor: pointer;
         color: #666;
         padding: 0;
         width: 30px;
         height: 30px;
         display: flex;
         align-items: center;
         justify-content: center;
         border-radius: 50%;
         transition: all 0.3s ease;
       }
       
       .close-btn:hover {
         background: #e9ecef;
         color: #333;
       }
       
       .edit-modal form {
         padding: 20px;
       }
       
       .edit-modal-actions {
         display: flex;
         gap: 10px;
         justify-content: flex-end;
         margin-top: 20px;
         padding-top: 20px;
         border-top: 1px solid #dee2e6;
       }
       
       .btn-secondary {
         background: #6c757d;
         color: white;
         border: none;
         padding: 10px 20px;
         border-radius: 4px;
         cursor: pointer;
         font-weight: bold;
         transition: all 0.3s ease;
       }
       
               .btn-secondary:hover {
          background: #5a6268;
        }
        
        .analytics-table {
          background: var(--table-bg);
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 2px 10px var(--admin-shadow);
          color: var(--admin-text);
        }
        
        .analytics-row {
          display: grid;
          grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
          padding: 15px;
          border-bottom: 1px solid #dee2e6;
          align-items: center;
          gap: 15px;
        }
        
        .analytics-header {
          background: var(--empty-state-bg);
          font-weight: bold;
          color: var(--admin-text);
        }
        
        .analytics-title {
          color: #007bff;
          text-decoration: none;
          font-weight: bold;
        }
        
        .analytics-title:hover {
          color: #0056b3;
        }
        
        .click-count {
          font-size: 1.2rem;
          font-weight: bold;
          color: #28a745;
        }
        
        .click-rate {
          font-size: 0.9rem;
          color: #666;
        }
        
        .last-click {
          font-size: 0.85rem;
          color: #666;
        }
        
        .nav-tabs .nav-link {
          color: #666;
          border: none;
          border-bottom: 3px solid transparent;
          transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link.active {
          color: #007bff;
          border-bottom-color: #007bff;
          background: none;
        }
        
        .nav-tabs .nav-link:hover {
          color: #007bff;
          border-bottom-color: #007bff;
        }
        
        @media (max-width: 768px) {
          .analytics-row {
            grid-template-columns: 1fr;
            gap: 10px;
          }
          
          .analytics-header {
            display: none;
          }
        }
    </style>
  </head>
  <body class="d-flex flex-column h-100">
    <main class="flex-shrink-0">
      <!-- Navigation-->
      <div id="nav-container"></div>
      
      <!-- Loading Screen (shown by default) -->
      <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
          <div class="spinner"></div>
          <h3>Verifying authentication...</h3>
          <p>Please wait while we check your credentials.</p>
        </div>
      </div>

      <!-- Admin Content (hidden by default) -->
      <div id="admin-content" class="admin-container" style="display: none;">
        <div class="admin-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="admin-title">Admin Panel</h1>
              <p class="admin-subtitle">Wait List Management - Full CRUD Operations</p>
            </div>
            <button onclick="logout()" class="btn btn-outline-danger">
              <i class="bi bi-box-arrow-right"></i> Logout
            </button>
          </div>
          
          <!-- Admin Tabs -->
          <div class="admin-tabs mt-4">
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="links-tab" data-bs-toggle="tab" data-bs-target="#links-panel" type="button" role="tab">
                  <i class="bi bi-link-45deg"></i> Manage Links
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="link-analytics-tab" data-bs-toggle="tab" data-bs-target="#link-analytics-panel" type="button" role="tab">
                  <i class="bi bi-link-45deg"></i> Link Analytics
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="site-analytics-tab" data-bs-toggle="tab" data-bs-target="#site-analytics-panel" type="button" role="tab">
                  <i class="bi bi-graph-up"></i> Site Analytics
                </button>
              </li>
            </ul>
          </div>
        </div>
        
                <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
          <!-- Links Management Tab -->
          <div class="tab-pane fade show active" id="links-panel" role="tabpanel">
            <!-- Stats Cards -->
            <div class="stats-cards">
              <div class="stat-card">
                <div class="stat-number" id="total-links">0</div>
                <div class="stat-label">Total Links</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="recent-links">0</div>
                <div class="stat-label">Added This Week</div>
              </div>
            </div>
            
            <!-- Add New Link Panel -->
            <div class="admin-panel">
              <h3><i class="bi bi-plus-circle"></i> Add New Link</h3>
              <form id="add-link-form" novalidate>
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="link-title">Title *</label>
                      <input type="text" class="form-control" id="link-title" required>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="link-url">URL *</label>
                      <input type="text" class="form-control" id="link-url" required placeholder="https://example.com or any URL">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="link-description">Description</label>
                      <input type="text" class="form-control" id="link-description">
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-admin">
                      <i class="bi bi-plus-circle"></i> Add Link
                    </button>
                  </div>
                </div>
              </form>
            </div>
            
            <!-- Links Management Table -->
            <div class="links-table">
              <div id="links-container">
                <div class="empty-state">
                  <i class="bi bi-link-45deg"></i>
                  <h4>No links yet</h4>
                  <p>Add your first link using the form above!</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Link Analytics Tab -->
          <div class="tab-pane fade" id="link-analytics-panel" role="tabpanel">
            <!-- Link Analytics Stats Cards -->
            <div class="stats-cards">
              <div class="stat-card">
                <div class="stat-number" id="total-clicks">0</div>
                <div class="stat-label">Total Link Clicks</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="active-links">0</div>
                <div class="stat-label">Active Links</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="avg-clicks">0</div>
                <div class="stat-label">Avg Clicks per Link</div>
              </div>
            </div>
            
            <!-- Link Analytics Table -->
            <div class="admin-panel">
              <h3><i class="bi bi-link-45deg"></i> Link Click Analytics</h3>
              <div class="analytics-table">
                <div id="link-analytics-container">
                  <div class="empty-state">
                    <i class="bi bi-link-45deg"></i>
                    <h4>No link click data yet</h4>
                    <p>Analytics will appear here once people start clicking on your links!</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Site Analytics Tab -->
          <div class="tab-pane fade" id="site-analytics-panel" role="tabpanel">
            <!-- Site Analytics Stats Cards -->
            <div class="stats-cards">
              <div class="stat-card">
                <div class="stat-number" id="total-pageviews">0</div>
                <div class="stat-label">Total Page Views</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="pageviews-today">0</div>
                <div class="stat-label">Views Today</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="total-sessions">0</div>
                <div class="stat-label">Total Sessions</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="avg-pages-session">0</div>
                <div class="stat-label">Avg Pages/Session</div>
              </div>
            </div>
            
            <!-- Site Analytics Panels -->
            <div class="row">
              <div class="col-lg-6">
                <!-- Popular Pages -->
                <div class="admin-panel">
                  <h3><i class="bi bi-file-earmark-text"></i> Popular Pages</h3>
                  <div id="popular-pages-container">
                    <div class="empty-state">
                      <i class="bi bi-file-earmark-text"></i>
                      <h4>No page data yet</h4>
                      <p>Page view data will appear here!</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-lg-6">
                <!-- Top Referrers -->
                <div class="admin-panel">
                  <h3><i class="bi bi-arrow-left-circle"></i> Top Referrers</h3>
                  <div id="top-referrers-container">
                    <div class="empty-state">
                      <i class="bi bi-arrow-left-circle"></i>
                      <h4>No referrer data yet</h4>
                      <p>Referrer data will appear here!</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-lg-6">
                <!-- Device Stats -->
                <div class="admin-panel">
                  <h3><i class="bi bi-display"></i> Device Types</h3>
                  <div id="device-stats-container">
                    <div class="empty-state">
                      <i class="bi bi-display"></i>
                      <h4>No device data yet</h4>
                      <p>Device data will appear here!</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-lg-6">
                <!-- Browser Stats -->
                <div class="admin-panel">
                  <h3><i class="bi bi-browser-chrome"></i> Browser Usage</h3>
                  <div id="browser-stats-container">
                    <div class="empty-state">
                      <i class="bi bi-browser-chrome"></i>
                      <h4>No browser data yet</h4>
                      <p>Browser data will appear here!</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Geographic Data -->
            <div class="row">
              <div class="col-lg-4">
                <!-- Top Countries -->
                <div class="admin-panel">
                  <h3><i class="bi bi-globe"></i> Top Countries</h3>
                  <div id="country-stats-container">
                    <div class="empty-state">
                      <i class="bi bi-globe"></i>
                      <h4>No country data yet</h4>
                      <p>Geographic data will appear here!</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-lg-4">
                <!-- Top Regions -->
                <div class="admin-panel">
                  <h3><i class="bi bi-geo-alt"></i> Top Regions</h3>
                  <div id="region-stats-container">
                    <div class="empty-state">
                      <i class="bi bi-geo-alt"></i>
                      <h4>No region data yet</h4>
                      <p>Regional data will appear here!</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-lg-4">
                <!-- Top Cities -->
                <div class="admin-panel">
                  <h3><i class="bi bi-building"></i> Top Cities</h3>
                  <div id="city-stats-container">
                    <div class="empty-state">
                      <i class="bi bi-building"></i>
                      <h4>No city data yet</h4>
                      <p>City data will appear here!</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 30-Day Trends -->
            <div class="admin-panel">
              <h3><i class="bi bi-graph-up"></i> 30-Day Trends</h3>
              <div id="daily-trends-container">
                <div class="empty-state">
                  <i class="bi bi-graph-up"></i>
                  <h4>No trend data yet</h4>
                  <p>Daily trend data will appear here!</p>
                </div>
              </div>
            </div>
          </div>
        </div>
       </div>
     </div>
   </main>

    <!-- Footer-->
    <div id="footer-container"></div>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script src="js/nav-component.js"></script>
    <script src="js/footer-component.js"></script>
    
    <!-- Admin Panel JS -->
    <script>
      // DOM elements for loading/content
      const loadingScreen = document.getElementById('loading-screen');
      const adminContent = document.getElementById('admin-content');
      
      // Check authentication on page load
      function checkAuthentication() {
        const adminCookie = getCookie('admin_authenticated');
        if (adminCookie !== 'true') {
          // Not authenticated, redirect to login
          window.location.href = 'admin-login.html';
          return;
        } else {
          // Authenticated, show admin content
          loadingScreen.style.display = 'none';
          adminContent.style.display = 'block';
        }
      }
      
      // Get cookie value
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }
      
      // Clear admin cookie (logout)
      function logout() {
        document.cookie = 'admin_authenticated=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;';
        window.location.href = 'admin-login.html';
      }
      
      // No password stored client-side - all validation happens server-side
      
      // Initialize links array
      let links = [];
      
      // DOM elements
      const addLinkForm = document.getElementById('add-link-form');
      const linksContainer = document.getElementById('links-container');
      const totalLinksElement = document.getElementById('total-links');
      const recentLinksElement = document.getElementById('recent-links');
      
      // Add new link
      addLinkForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('link-title').value;
        let url = document.getElementById('link-url').value.trim();
        const description = document.getElementById('link-description').value;
        
        // Normalize URL - add https:// if no protocol is specified
        if (url && !url.match(/^https?:\/\//)) {
          url = 'https://' + url;
        }
        
        try {
          const response = await fetch('https://danielwaitwebsite.danielwait1216.workers.dev/api/links', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              title,
              url,
              description
            })
          });
          
          if (response.ok) {
            addLinkForm.reset();
            loadLinks();
            alert('Link added successfully!');
          } else {
            const error = await response.json();
            alert('Error: ' + error.error);
          }
        } catch (error) {
          alert('Error adding link: ' + error.message);
        }
      });
      
      // Load links from API
      async function loadLinks() {
        try {
          const response = await fetch('https://danielwaitwebsite.danielwait1216.workers.dev/api/links');
          if (response.ok) {
            links = await response.json();
            displayLinks();
            updateStats();
          } else {
            console.error('Failed to load links');
          }
        } catch (error) {
          console.error('Error loading links:', error);
        }
      }
      
      // Update statistics
      function updateStats() {
        totalLinksElement.textContent = links.length;
        
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const recentLinks = links.filter(link => new Date(link.date) > oneWeekAgo);
        recentLinksElement.textContent = recentLinks.length;
      }
      
      // Display links in table format
      function displayLinks() {
        if (links.length === 0) {
          linksContainer.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-link-45deg"></i>
              <h4>No links yet</h4>
              <p>Add your first link using the form above!</p>
            </div>
          `;
          return;
        }
        
        linksContainer.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th>Title</th>
                <th>URL</th>
                <th>Description</th>
                <th>Date Added</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${links.map(link => `
                <tr>
                  <td>
                    <a href="${link.url}" target="_blank" class="link-title">
                      ${link.title}
                    </a>
                  </td>
                  <td>
                    <a href="${link.url}" target="_blank" class="link-title">
                      ${link.url}
                    </a>
                  </td>
                  <td>${link.description || '-'}</td>
                  <td>${link.date}</td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn btn-sm btn-success" onclick="editLink(${link.id})">
                        <i class="bi bi-pencil"></i> Edit
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteLink(${link.id})">
                        <i class="bi bi-trash"></i> Delete
                      </button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
      
      // Edit link functionality
      function editLink(id) {
        const link = links.find(l => l.id === id);
        if (!link) {
          alert('Link not found!');
          return;
        }
        
        // Create edit modal
        const modal = document.createElement('div');
        modal.className = 'edit-modal';
        modal.innerHTML = `
          <div class="edit-modal-content">
            <div class="edit-modal-header">
              <h3><i class="bi bi-pencil"></i> Edit Link</h3>
              <button onclick="closeEditModal()" class="close-btn">&times;</button>
            </div>
            <form id="edit-link-form">
              <div class="form-group">
                <label for="edit-title">Title *</label>
                <input type="text" class="form-control" id="edit-title" value="${link.title}" required>
              </div>
              <div class="form-group">
                <label for="edit-url">URL *</label>
                <input type="text" class="form-control" id="edit-url" value="${link.url}" required>
              </div>
              <div class="form-group">
                <label for="edit-description">Description</label>
                <input type="text" class="form-control" id="edit-description" value="${link.description || ''}">
              </div>
              <div class="edit-modal-actions">
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-success">Save Changes</button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Handle form submission
        document.getElementById('edit-link-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const title = document.getElementById('edit-title').value.trim();
          let url = document.getElementById('edit-url').value.trim();
          const description = document.getElementById('edit-description').value.trim();
          
          // Normalize URL
          if (url && !url.match(/^https?:\/\//)) {
            url = 'https://' + url;
          }
          
          try {
            const response = await fetch(`https://danielwaitwebsite.danielwait1216.workers.dev/api/links/${id}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                title,
                url,
                description
              })
            });
            
            if (response.ok) {
              closeEditModal();
              loadLinks();
              alert('Link updated successfully!');
            } else {
              const error = await response.json();
              alert('Error: ' + error.error);
            }
          } catch (error) {
            alert('Error updating link: ' + error.message);
          }
        });
      }
      
      // Close edit modal
      function closeEditModal() {
        const modal = document.querySelector('.edit-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      // Delete link
      async function deleteLink(id) {
        if (confirm('Are you sure you want to delete this link?')) {
          try {
            const response = await fetch(`https://danielwaitwebsite.danielwait1216.workers.dev/api/links/${id}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
              }
            });
            
            if (response.ok) {
              loadLinks();
              alert('Link deleted successfully!');
            } else {
              const error = await response.json();
              alert('Error: ' + error.error);
            }
          } catch (error) {
            alert('Error deleting link: ' + error.message);
          }
        }
      }
      
      // Load analytics data
      async function loadAnalytics() {
        try {
          const response = await fetch('https://danielwaitwebsite.danielwait1216.workers.dev/api/analytics');
          if (response.ok) {
            const data = await response.json();
            displayAnalytics(data);
          } else {
            console.error('Failed to load analytics');
          }
        } catch (error) {
          console.error('Error loading analytics:', error);
        }
      }
      
      // Display link analytics data
      function displayLinkAnalytics(data) {
        // Update link analytics stats
        document.getElementById('total-clicks').textContent = data.totalLinkClicks || 0;
        document.getElementById('active-links').textContent = data.activeLinks || 0;
        document.getElementById('avg-clicks').textContent = data.totalLinks > 0 ? 
          Math.round((data.totalLinkClicks || 0) / data.totalLinks * 10) / 10 : 0;
        
        // Display link analytics table
        const linkAnalyticsContainer = document.getElementById('link-analytics-container');
        
        if (!data.linkAnalytics || data.linkAnalytics.length === 0) {
          linkAnalyticsContainer.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-link-45deg"></i>
              <h4>No link click data yet</h4>
              <p>Analytics will appear here once people start clicking on your links!</p>
            </div>
          `;
          return;
        }
        
        // Sort by click count (highest first)
        const sortedAnalytics = data.linkAnalytics.sort((a, b) => b.clicks - a.clicks);
        
        linkAnalyticsContainer.innerHTML = `
          <div class="analytics-row analytics-header">
            <div>Link Title</div>
            <div>Total Clicks</div>
            <div>Today</div>
            <div>This Week</div>
            <div>Last Click</div>
          </div>
          ${sortedAnalytics.map(item => {
            const today = new Date().toISOString().split('T')[0];
            const todayClicks = item.dailyClicks[today] || 0;
            
            // Calculate this week's clicks
            const weekClicks = Object.entries(item.dailyClicks)
              .filter(([date]) => {
                const clickDate = new Date(date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return clickDate >= weekAgo;
              })
              .reduce((sum, [, clicks]) => sum + clicks, 0);
            
            const lastClick = item.lastClick ? 
              new Date(item.lastClick).toLocaleDateString() : 'Never';
            
            return `
              <div class="analytics-row">
                <div>
                  <a href="${item.url}" target="_blank" class="analytics-title">
                    ${item.title}
                  </a>
                </div>
                <div class="click-count">${item.clicks}</div>
                <div class="click-rate">${todayClicks}</div>
                <div class="click-rate">${weekClicks}</div>
                <div class="last-click">${lastClick}</div>
              </div>
            `;
          }).join('')}
        `;
      }
      
      // Display site analytics data
      function displaySiteAnalytics(data) {
        const siteStats = data.siteStats || {};
        
        // Update site analytics stats
        document.getElementById('total-pageviews').textContent = siteStats.totalPageViews || 0;
        document.getElementById('pageviews-today').textContent = siteStats.pageViewsToday || 0;
        document.getElementById('total-sessions').textContent = siteStats.totalSessions || 0;
        document.getElementById('avg-pages-session').textContent = siteStats.avgPagesPerSession || 0;
        
        // Display popular pages
        displayPopularPages(siteStats.popularPages || []);
        
        // Display top referrers
        displayTopReferrers(siteStats.topReferrers || []);
        
        // Display device stats
        displayDeviceStats(siteStats.deviceStats || []);
        
        // Display browser stats
        displayBrowserStats(siteStats.browserStats || []);
        
        // Display geographic data
        displayCountryStats(siteStats.countryStats || []);
        displayRegionStats(siteStats.regionStats || []);
        displayCityStats(siteStats.cityStats || []);
        
        // Display 30-day trends
        displayDailyTrends(siteStats.dailyTrends || []);
      }
      
      function displayPopularPages(pages) {
        const container = document.getElementById('popular-pages-container');
        if (pages.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-file-earmark-text"></i>
              <h4>No page data yet</h4>
              <p>Page view data will appear here!</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = pages.slice(0, 5).map(page => `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
            <div>
              <strong>${page.page}</strong>
              <small class="text-muted d-block">Today: ${page.todayViews}</small>
            </div>
            <div class="text-primary fw-bold">${page.views}</div>
          </div>
        `).join('');
      }
      
      function displayTopReferrers(referrers) {
        const container = document.getElementById('top-referrers-container');
        if (referrers.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-arrow-left-circle"></i>
              <h4>No referrer data yet</h4>
              <p>Referrer data will appear here!</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = referrers.slice(0, 5).map(ref => `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
            <div>
              <strong>${ref.domain}</strong>
              <small class="text-muted d-block">Today: ${ref.todayReferrals}</small>
            </div>
            <div class="text-success fw-bold">${ref.referrals}</div>
          </div>
        `).join('');
      }
      
      function displayDeviceStats(devices) {
        const container = document.getElementById('device-stats-container');
        if (devices.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-display"></i>
              <h4>No device data yet</h4>
              <p>Device data will appear here!</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = devices.slice(0, 5).map(device => `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
            <div>
              <strong>${device.type}</strong>
              <small class="text-muted d-block">${device.resolution}</small>
            </div>
            <div class="text-info fw-bold">${device.count}</div>
          </div>
        `).join('');
      }
      
      function displayBrowserStats(browsers) {
        const container = document.getElementById('browser-stats-container');
        if (browsers.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-browser-chrome"></i>
              <h4>No browser data yet</h4>
              <p>Browser data will appear here!</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = browsers.slice(0, 5).map(browser => `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
            <div>
              <strong>${browser.browser}</strong>
              <small class="text-muted d-block">Today: ${browser.todayUsers}</small>
            </div>
            <div class="text-warning fw-bold">${browser.count}</div>
          </div>
        `).join('');
      }
      
      function displayCountryStats(countries) {
        const container = document.getElementById('country-stats-container');
        if (countries.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-globe"></i>
              <h4>No country data yet</h4>
              <p>Geographic data will appear here!</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = countries.slice(0, 5).map(country => `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
            <div>
              <strong>${getCountryFlag(country.country)} ${country.country}</strong>
              <small class="text-muted d-block">Today: ${country.todayVisitors}</small>
            </div>
            <div class="text-success fw-bold">${country.count}</div>
          </div>
        `).join('');
      }
      
      function displayRegionStats(regions) {
        const container = document.getElementById('region-stats-container');
        if (regions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-geo-alt"></i>
              <h4>No region data yet</h4>
              <p>Regional data will appear here!</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = regions.slice(0, 5).map(region => `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
            <div>
              <strong>${region.region}</strong>
              <small class="text-muted d-block">${region.country} ‚Ä¢ Today: ${region.todayVisitors}</small>
            </div>
            <div class="text-info fw-bold">${region.count}</div>
          </div>
        `).join('');
      }
      
      function displayCityStats(cities) {
        const container = document.getElementById('city-stats-container');
        if (cities.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-building"></i>
              <h4>No city data yet</h4>
              <p>City data will appear here!</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = cities.slice(0, 5).map(city => `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
            <div>
              <strong>${city.city}</strong>
              <small class="text-muted d-block">${city.country} ‚Ä¢ Today: ${city.todayVisitors}</small>
            </div>
            <div class="text-warning fw-bold">${city.count}</div>
          </div>
        `).join('');
      }
      
      // Helper function to get country flag emoji
      function getCountryFlag(countryCode) {
        const flagMap = {
          'US': 'üá∫üá∏', 'CA': 'üá®üá¶', 'GB': 'üá¨üáß', 'DE': 'üá©üá™', 'FR': 'üá´üá∑', 
          'ES': 'üá™üá∏', 'IT': 'üáÆüáπ', 'JP': 'üáØüáµ', 'CN': 'üá®üá≥', 'IN': 'üáÆüá≥',
          'BR': 'üáßüá∑', 'MX': 'üá≤üáΩ', 'AU': 'üá¶üá∫', 'RU': 'üá∑üá∫', 'KR': 'üá∞üá∑',
          'NL': 'üá≥üá±', 'SE': 'üá∏üá™', 'NO': 'üá≥üá¥', 'DK': 'üá©üá∞', 'FI': 'üá´üáÆ',
          'PL': 'üáµüá±', 'TR': 'üáπüá∑', 'AR': 'üá¶üá∑', 'CL': 'üá®üá±', 'CO': 'üá®üá¥'
        };
        return flagMap[countryCode] || 'üåç';
      }
      
      function displayDailyTrends(trends) {
        const container = document.getElementById('daily-trends-container');
        if (trends.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-graph-up"></i>
              <h4>No trend data yet</h4>
              <p>Daily trend data will appear here!</p>
            </div>
          `;
          return;
        }
        
        const maxViews = Math.max(...trends.map(t => t.pageViews), 1);
        const maxSessions = Math.max(...trends.map(t => t.sessions), 1);
        const maxValue = Math.max(maxViews, maxSessions);
        const chartHeight = 200;
        const chartWidth = 800;
        const padding = 40;
        
        // Create points for both lines
        const viewsPoints = trends.map((trend, index) => {
          const x = padding + (index * (chartWidth - 2 * padding)) / (trends.length - 1);
          const y = chartHeight - padding - ((trend.pageViews / maxValue) * (chartHeight - 2 * padding));
          return { x, y, data: trend };
        });
        
        const sessionsPoints = trends.map((trend, index) => {
          const x = padding + (index * (chartWidth - 2 * padding)) / (trends.length - 1);
          const y = chartHeight - padding - ((trend.sessions / maxValue) * (chartHeight - 2 * padding));
          return { x, y, data: trend };
        });
        
        const viewsPathData = viewsPoints.map((point, index) => 
          `${index === 0 ? 'M' : 'L'} ${point.x} ${point.y}`
        ).join(' ');
        
        const sessionsPathData = sessionsPoints.map((point, index) => 
          `${index === 0 ? 'M' : 'L'} ${point.x} ${point.y}`
        ).join(' ');
        
        container.innerHTML = `
          <div class="line-chart-container" style="position: relative; background: var(--bg-color, white); border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px var(--shadow-color, rgba(0,0,0,0.1)); border: 1px solid var(--border-color, #e0e0e0);">
            <svg width="${chartWidth}" height="${chartHeight}" style="overflow: visible;">
              <!-- Grid lines -->
              ${Array.from({length: 6}, (_, i) => {
                const y = padding + (i * (chartHeight - 2 * padding)) / 5;
                const value = Math.round(maxValue - (i * maxValue) / 5);
                return `
                  <line x1="${padding}" y1="${y}" x2="${chartWidth - padding}" y2="${y}" 
                        stroke="var(--border-color, #f0f0f0)" stroke-width="1"/>
                  <text x="${padding - 10}" y="${y + 4}" fill="var(--text-color, #666)" font-size="12" text-anchor="end">${value}</text>
                `;
              }).join('')}
              
              <!-- Page Views Line -->
              <path d="${viewsPathData}" stroke="#007bff" stroke-width="3" fill="none"/>
              
              <!-- Sessions Line -->
              <path d="${sessionsPathData}" stroke="#28a745" stroke-width="3" fill="none"/>
              
              <!-- Page Views Data points -->
              ${viewsPoints.map(point => `
                <circle cx="${point.x}" cy="${point.y}" r="4" fill="#007bff" stroke="white" stroke-width="2"
                        data-date="${point.data.date}" 
                        data-views="${point.data.pageViews}" 
                        data-sessions="${point.data.sessions}"
                        data-display-date="${point.data.displayDate || new Date(point.data.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}"
                        data-type="views"
                        style="cursor: pointer;"
                        class="chart-point"/>
              `).join('')}
              
              <!-- Sessions Data points -->
              ${sessionsPoints.map(point => `
                <circle cx="${point.x}" cy="${point.y}" r="4" fill="#28a745" stroke="white" stroke-width="2"
                        data-date="${point.data.date}" 
                        data-views="${point.data.pageViews}" 
                        data-sessions="${point.data.sessions}"
                        data-display-date="${point.data.displayDate || new Date(point.data.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}"
                        data-type="sessions"
                        style="cursor: pointer;"
                        class="chart-point"/>
              `).join('')}
              
              <!-- X-axis labels (show every 5th day) -->
              ${viewsPoints.filter((_, i) => i % 5 === 0 || i === viewsPoints.length - 1).map(point => `
                <text x="${point.x}" y="${chartHeight - 10}" fill="var(--text-color, #666)" font-size="11" text-anchor="middle">
                  ${point.data.displayDate || new Date(point.data.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                </text>
              `).join('')}
            </svg>
            
            <!-- Legend -->
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 15px; font-size: 14px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 20px; height: 3px; background: #007bff; border-radius: 2px;"></div>
                <span style="color: var(--text-color, #333);">Page Views</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 20px; height: 3px; background: #28a745; border-radius: 2px;"></div>
                <span style="color: var(--text-color, #333);">Sessions</span>
              </div>
            </div>
            
            <!-- Tooltip -->
            <div id="chart-tooltip" style="
              position: absolute; 
              background: rgba(0,0,0,0.8); 
              color: white; 
              padding: 8px 12px; 
              border-radius: 4px; 
              font-size: 12px; 
              pointer-events: none; 
              opacity: 0; 
              transition: opacity 0.2s;
              z-index: 1000;
            "></div>
          </div>
        `;
        
        // Add hover interactions
        const chartPoints = container.querySelectorAll('.chart-point');
        const tooltip = container.querySelector('#chart-tooltip');
        
        chartPoints.forEach(point => {
          point.addEventListener('mouseenter', (e) => {
            const date = e.target.getAttribute('data-display-date');
            const views = e.target.getAttribute('data-views');
            const sessions = e.target.getAttribute('data-sessions');
            const type = e.target.getAttribute('data-type');
            
            if (type === 'views') {
              tooltip.innerHTML = `
                <div><strong>${date}</strong></div>
                <div style="color: #007bff;">üìä ${views} page views</div>
                <div style="color: #666; font-size: 11px;">${sessions} sessions on this day</div>
              `;
            } else {
              tooltip.innerHTML = `
                <div><strong>${date}</strong></div>
                <div style="color: #28a745;">üë• ${sessions} sessions</div>
                <div style="color: #666; font-size: 11px;">${views} page views on this day</div>
              `;
            }
            tooltip.style.opacity = '1';
          });
          
          point.addEventListener('mousemove', (e) => {
            const rect = container.getBoundingClientRect();
            tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
            tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
          });
          
          point.addEventListener('mouseleave', () => {
            tooltip.style.opacity = '0';
          });
        });
      }
      
      // Main display function that calls both
      function displayAnalytics(data) {
        displayLinkAnalytics(data);
        displaySiteAnalytics(data);
      }
      
      // Tab switching handler
      document.addEventListener('shown.bs.tab', function (e) {
        const target = e.target.getAttribute('data-bs-target');
        if (target === '#link-analytics-panel' || target === '#site-analytics-panel') {
          loadAnalytics();
        }
      });
      
      // Load links on page load
      document.addEventListener('DOMContentLoaded', () => {
        checkAuthentication();
        loadLinks();
      });
    </script>
  </body>
</html>
